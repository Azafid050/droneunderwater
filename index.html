<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHRONO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            dark: '#0a192f',
                            card: '#112240',
                            border: '#1e2d4a',
                            accent: '#64ffda'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @keyframes pulse-soft {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .animate-pulse-soft {
            animation: pulse-soft 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        .glass {
            background: rgba(17, 34, 64, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(100, 255, 218, 0.1);
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #0a192f;
        }

        ::-webkit-scrollbar-thumb {
            background: #64ffda;
            border-radius: 10px;
        }

        .tab-active {
            color: #64ffda;
            border-bottom: 2px solid #64ffda;
        }

        .sensor-card {
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .sensor-card:hover {
            transform: translateY(-5px);
        }

        .sensor-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
        }

        .card-ph::before {
            background: linear-gradient(to right, #2196f3, #64ffda);
        }

        .card-turbidity::before {
            background: linear-gradient(to right, #4caf50, #64ffda);
        }

        .card-battery::before {
            background: linear-gradient(to right, #a855f7, #64ffda);
        }

        .alert {
            padding: 12px 20px;
            border-radius: 8px;
            margin: 10px 0;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.5s ease;
        }

        .alert-warning {
            background: rgba(255, 152, 0, 0.15);
            color: #ff9800;
            border-left: 4px solid #ff9800;
        }

        .alert-danger {
            background: rgba(244, 67, 54, 0.15);
            color: #f44336;
            border-left: 4px solid #f44336;
        }

        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>

<body class="bg-brand-dark text-slate-100 min-h-screen font-sans">

    <!-- Header -->
    <header class="border-b border-brand-border sticky top-0 z-50 glass">
        <div class="max-w-[1400px] mx-auto px-6 py-4 flex items-center justify-between">
            <div class="flex flex-col">
                <h1 class="text-xl font-bold tracking-wider leading-none text-brand-accent">CHRONO</h1>
                <p class="text-[10px] text-zinc-400 font-semibold tracking-widest mt-1 uppercase">Underwater Drone - Real-time Water Quality Monitoring</p>
            </div>

            <div class="flex items-center gap-8">
                <!-- Connection Status -->
                <div class="flex items-center gap-2">
                    <div class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse-soft" id="connection-status"></div>
                    <span id="connection-text" class="text-xs font-medium text-zinc-400">Koneksi Drone: Stabil</span>
                </div>

                <!-- Clock -->
                <div class="hidden md:flex flex-col items-end">
                    <span class="text-[10px] font-bold text-zinc-500 uppercase">Live Update</span>
                    <span id="clock" class="text-xl font-mono font-medium text-brand-accent">00:00:00</span>
                </div>

                <!-- Sync Status -->
                <div class="flex flex-col items-end border-l border-brand-border pl-8">
                    <span class="text-[10px] font-bold text-zinc-500 uppercase">Sync Status</span>
                    <div class="flex items-center gap-2">
                        <div class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse-soft"></div>
                        <span id="syncStatus" class="text-sm font-mono font-medium text-emerald-500 uppercase">Connected</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Alert Container -->
    <div class="max-w-[1400px] mx-auto px-6 mt-4" id="alerts-container"></div>

    <!-- Navigation Tabs -->
    <nav class="max-w-[1400px] mx-auto px-6 mt-6">
        <div class="flex gap-8 border-b border-brand-border">
            <button onclick="switchTab('monitoring')" id="tab-monitoring"
                class="pb-3 text-xs font-bold tracking-widest uppercase transition-all tab-active">Monitoring</button>
            <button onclick="switchTab('reports')" id="tab-reports"
                class="pb-3 text-xs font-bold tracking-widest uppercase transition-all text-zinc-500 hover:text-brand-accent">Reports</button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-[1400px] mx-auto px-6 py-8">

        <!-- Monitoring Section -->
        <section id="section-monitoring" class="space-y-8 block">
            <div class="flex justify-between items-end">
                <div>
                    <h2 class="text-3xl font-bold text-zinc-100">Real-time <span class="text-brand-accent">Telemetry</span></h2>
                    <p class="text-zinc-500 mt-2">Live data from underwater probe</p>
                </div>
                <button onclick="refreshSystem()" id="refreshBtn"
                    class="px-6 py-2 bg-brand-accent text-brand-dark rounded-lg text-xs font-bold uppercase tracking-widest hover:bg-cyan-300 transition-all flex items-center gap-2">
                    <i data-lucide="refresh-cw" class="w-3 h-3" id="refreshIcon"></i>
                    Refresh System
                </button>
            </div>

            <!-- Stats Grid - 3 Cards sesuai database -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- PH Card -->
                <div class="sensor-card card-ph p-6 rounded-2xl bg-brand-card border border-brand-border">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-vial text-cyan-400"></i>
                            <h3 class="text-[10px] font-bold text-zinc-400 uppercase">pH Level</h3>
                        </div>
                        <span class="px-2 py-1 bg-cyan-500/10 text-cyan-400 text-[8px] font-black rounded-full border border-cyan-500/20 uppercase" id="ph-status">NORMAL</span>
                    </div>
                    <div class="flex items-baseline gap-1">
                        <span class="text-4xl font-bold text-cyan-400" id="val-ph">0.0</span>
                        <span class="text-zinc-500 text-sm">pH</span>
                    </div>
                    <div class="mt-4">
                        <div class="w-full h-1.5 bg-zinc-700 rounded-full overflow-hidden">
                            <div class="h-full bg-gradient-to-r from-cyan-500 to-brand-accent rounded-full" id="ph-bar" style="width: 0%;"></div>
                        </div>
                        <div class="flex justify-between mt-2 text-[10px] text-zinc-500">
                            <span>Asam: 0</span>
                            <span id="ph-percent">0%</span>
                            <span>Basa: 14</span>
                        </div>
                    </div>
                </div>

                <!-- Water Turbidity Card -->
                <div class="sensor-card card-turbidity p-6 rounded-2xl bg-brand-card border border-brand-border">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-water text-green-400"></i>
                            <h3 class="text-[10px] font-bold text-zinc-400 uppercase">Kekeruhan</h3>
                        </div>
                        <span class="px-2 py-1 bg-green-500/10 text-green-400 text-[8px] font-black rounded-full border border-green-500/20 uppercase" id="turbidity-status">JERNIH</span>
                    </div>
                    <div class="flex items-baseline gap-1">
                        <span class="text-4xl font-bold text-green-400" id="val-water">0</span>
                        <span class="text-zinc-500 text-sm">NTU</span>
                    </div>
                    <div class="mt-4">
                        <div class="w-full h-1.5 bg-zinc-700 rounded-full overflow-hidden">
                            <div class="h-full bg-gradient-to-r from-green-500 to-brand-accent rounded-full" id="turbidity-bar" style="width: 0%;"></div>
                        </div>
                        <div class="flex justify-between mt-2 text-[10px] text-zinc-500">
                            <span>Jernih: 0</span>
                            <span id="turbidity-percent">0%</span>
                            <span>Keruh: 100</span>
                        </div>
                    </div>
                </div>

                <!-- Battery Card -->
                <div class="sensor-card card-battery p-6 rounded-2xl bg-brand-card border border-brand-border">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-battery-three-quarters text-purple-400"></i>
                            <h3 class="text-[10px] font-bold text-zinc-400 uppercase">Baterai</h3>
                        </div>
                        <span class="px-2 py-1 bg-purple-500/10 text-purple-400 text-[8px] font-black rounded-full border border-purple-500/20 uppercase" id="battery-status">NORMAL</span>
                    </div>
                    <div class="flex items-baseline gap-1">
                        <span class="text-4xl font-bold text-purple-400" id="val-battery">0</span>
                        <span class="text-zinc-500 text-sm">%</span>
                    </div>
                    <div class="mt-4">
                        <div class="w-full h-1.5 bg-zinc-700 rounded-full overflow-hidden">
                            <div class="h-full bg-gradient-to-r from-purple-500 to-brand-accent rounded-full" id="battery-bar" style="width: 0%;"></div>
                        </div>
                        <div class="flex justify-between mt-2 text-[10px] text-zinc-500">
                            <span>Min: 0%</span>
                            <span id="battery-percent">0%</span>
                            <span>Max: 100%</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chart Container - 3 Dataset -->
            <div class="p-8 rounded-2xl bg-brand-card border border-brand-border">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8">
                    <div class="flex items-center gap-3">
                        <div class="w-1.5 h-6 bg-brand-accent rounded-full"></div>
                        <h3 class="text-xs font-bold uppercase tracking-widest text-brand-accent">Historical Trend (20 Data Terakhir)</h3>
                    </div>
                    <!-- Legend -->
                    <div class="flex flex-wrap gap-4 text-[10px] font-bold uppercase">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-cyan-500"></div>
                            <span class="text-zinc-400">pH</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-green-500"></div>
                            <span class="text-zinc-400">Turbidity</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-purple-500"></div>
                            <span class="text-zinc-400">Battery</span>
                        </div>
                    </div>
                </div>
                <div class="h-[350px] w-full">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
        </section>

        <!-- Reports Section -->
        <section id="section-reports" class="space-y-8 hidden">
            <div>
                <h2 class="text-3xl font-bold text-zinc-100">Data <span class="text-brand-accent">Reports</span></h2>
                <p class="text-zinc-500 mt-2">Historical summary from database</p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Summary Card -->
                <div class="lg:col-span-1 p-6 rounded-2xl glass space-y-6">
                    <div class="flex justify-between items-center">
                        <h3 class="text-xs font-bold text-brand-accent uppercase">Report Summary</h3>
                        <select onchange="fetchReports(this.value)"
                            class="bg-transparent border-none text-[10px] font-bold uppercase text-brand-accent focus:ring-0 cursor-pointer">
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                            <option value="monthly">Monthly</option>
                        </select>
                    </div>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center p-3 rounded-xl bg-zinc-800/50">
                            <span class="text-xs text-zinc-500 font-bold uppercase">Avg pH</span>
                            <span id="rep-avg-ph" class="font-bold text-cyan-400">0.00</span>
                        </div>
                        <div class="flex justify-between items-center p-3 rounded-xl bg-zinc-800/50">
                            <span class="text-xs text-zinc-500 font-bold uppercase">Max Turbidity</span>
                            <span id="rep-max-turb" class="font-bold text-green-400">0 NTU</span>
                        </div>
                        <div class="flex justify-between items-center p-3 rounded-xl bg-zinc-800/50">
                            <span class="text-xs text-zinc-500 font-bold uppercase">Avg Battery</span>
                            <span id="rep-avg-battery" class="font-bold text-purple-400">0%</span>
                        </div>
                        <div class="flex justify-between items-center p-3 rounded-xl bg-zinc-800/50">
                            <span class="text-xs text-zinc-500 font-bold uppercase">Total Logs</span>
                            <span id="rep-total-logs" class="font-bold">0</span>
                        </div>
                    </div>
                    <button onclick="exportToPDF()" id="pdfBtn"
                        class="w-full py-4 bg-brand-accent text-brand-dark rounded-xl font-bold uppercase tracking-widest text-xs hover:bg-blue-400 transition-all flex items-center justify-center gap-2">
                        <i class="fas fa-download w-4 h-4"></i>
                        <span>Export Report (PDF)</span>
                    </button>
                </div>

                <!-- History Table - 4 Kolom -->
                <div class="lg:col-span-2 rounded-2xl bg-brand-card border border-brand-border overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-zinc-800/50 border-b border-brand-border">
                            <tr>
                                <th class="px-6 py-4 text-[10px] font-black uppercase text-zinc-500">Timestamp</th>
                                <th class="px-6 py-4 text-[10px] font-black uppercase text-zinc-500">pH</th>
                                <th class="px-6 py-4 text-[10px] font-black uppercase text-zinc-500">Turbidity (NTU)</th>
                                <th class="px-6 py-4 text-[10px] font-black uppercase text-zinc-500">Battery (%)</th>
                            </tr>
                        </thead>
                        <tbody id="report-table-body" class="divide-y divide-brand-border">
                            <tr id="report-table-placeholder">
                                <td colspan="4" class="px-6 py-10 text-center text-xs text-zinc-400">Memuat data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <footer class="max-w-[1400px] mx-auto px-6 py-12 text-center">
        <p class="text-[10px] text-zinc-500 font-bold uppercase tracking-[0.2em]">CHRONO OS 1.0 - 3 Sensor Active</p>
    </footer>

    <script>
        // Lucide Icons
        lucide.createIcons();

        // Clock
        let startTime = Date.now();
        function updateClock() {
            const now = new Date();
            document.getElementById('clock').textContent = now.toLocaleTimeString('id-ID', { hour12: false });
            
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const hrs = String(Math.floor(elapsed / 3600)).padStart(2, '0');
            const mins = String(Math.floor((elapsed % 3600) / 60)).padStart(2, '0');
            const secs = String(elapsed % 60).padStart(2, '0');
            document.getElementById('syncStatus').textContent = `${hrs}:${mins}:${secs}`;
        }
        setInterval(updateClock, 1000);
        updateClock();

        // Tab Management
        function switchTab(tab) {
            const monSection = document.getElementById('section-monitoring');
            const repSection = document.getElementById('section-reports');
            const monTab = document.getElementById('tab-monitoring');
            const repTab = document.getElementById('tab-reports');

            if (tab === 'monitoring') {
                monSection.classList.remove('hidden');
                repSection.classList.add('hidden');
                monTab.classList.add('tab-active');
                repTab.classList.remove('tab-active');
            } else {
                monSection.classList.add('hidden');
                repSection.classList.remove('hidden');
                repTab.classList.add('tab-active');
                monTab.classList.remove('tab-active');
            }
        }

        // Chart
        const ctx = document.getElementById('trendChart').getContext('2d');
        let trendChart;

        function initChart() {
            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array.from({ length: 20 }, (_, i) => `${i*3}s`),
                    datasets: [
                        {
                            label: 'pH',
                            data: Array(20).fill(null),
                            borderColor: '#2196f3',
                            backgroundColor: 'rgba(33,150,243,0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true,
                            pointRadius: 0,
                        },
                        {
                            label: 'Turbidity',
                            data: Array(20).fill(null),
                            borderColor: '#4caf50',
                            backgroundColor: 'rgba(76,175,80,0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true,
                            pointRadius: 0,
                        },
                        {
                            label: 'Battery',
                            data: Array(20).fill(null),
                            borderColor: '#a855f7',
                            backgroundColor: 'rgba(168,85,247,0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true,
                            pointRadius: 0,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { grid: { display: false }, ticks: { color: '#a8b2d1' } },
                        y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#a8b2d1' } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // Fetch Data dari API
        let lastDataId = null;

        async function fetchData() {
            try {
                const response = await fetch('api.php?get_latest=true');
                const data = await response.json();

                if (data.status !== "empty" && data.id) {
                    if (data.id !== lastDataId) {
                        lastDataId = data.id;

                        // Update nilai
                        document.getElementById('val-ph').textContent = parseFloat(data.kualitas_air).toFixed(1);
                        document.getElementById('val-water').textContent = Math.floor(data.tahan);
                        document.getElementById('val-battery').textContent = Math.floor(data.daya_listrik);

                        // Update chart
                        if (trendChart) {
                            trendChart.data.datasets[0].data.shift();
                            trendChart.data.datasets[0].data.push(parseFloat(data.kualitas_air));
                            trendChart.data.datasets[1].data.shift();
                            trendChart.data.datasets[1].data.push(parseFloat(data.tahan));
                            trendChart.data.datasets[2].data.shift();
                            trendChart.data.datasets[2].data.push(parseFloat(data.daya_listrik));
                            trendChart.update('none');
                        }

                        // Update progress bars
                        const phPercent = ((parseFloat(data.kualitas_air) - 4) / 6) * 100;
                        document.getElementById('ph-bar').style.width = Math.min(100, Math.max(0, phPercent)) + '%';
                        document.getElementById('ph-percent').textContent = Math.round(phPercent) + '%';
                        
                        const turbidityPercent = (data.tahan / 50) * 100;
                        document.getElementById('turbidity-bar').style.width = Math.min(100, Math.max(0, turbidityPercent)) + '%';
                        document.getElementById('turbidity-percent').textContent = Math.round(turbidityPercent) + '%';
                        
                        const batteryPercent = data.daya_listrik;
                        document.getElementById('battery-bar').style.width = batteryPercent + '%';
                        document.getElementById('battery-percent').textContent = Math.round(batteryPercent) + '%';

                        // Update status
                        document.getElementById('ph-status').textContent = 
                            data.kualitas_air < 6.5 ? 'ASAM' : data.kualitas_air > 8.5 ? 'BASA' : 'NORMAL';
                        document.getElementById('turbidity-status').textContent = 
                            data.tahan < 5 ? 'JERNIH' : data.tahan < 10 ? 'SEDANG' : 'KERUH';
                        document.getElementById('battery-status').textContent = 
                            data.daya_listrik > 60 ? 'NORMAL' : data.daya_listrik > 20 ? 'RENDAH' : 'KRITIS';

                        // Reset timer
                        startTime = Date.now();
                        document.getElementById('connection-text').textContent = 'Koneksi Drone: Stabil';
                        document.getElementById('connection-status').style.backgroundColor = '#10b981';
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('connection-text').textContent = 'Koneksi Drone: Gangguan';
                document.getElementById('connection-status').style.backgroundColor = '#f44336';
            }
        }

        // Fetch Reports
        async function fetchReports(period = 'daily') {
            try {
                const response = await fetch(`api.php?get_reports=true&period=${period}`);
                const result = await response.json();

                if (result.status === "success") {
                    const s = result.summary;
                    
                    document.getElementById('rep-avg-ph').textContent = 
                        s.avg_kualitas_air ? parseFloat(s.avg_kualitas_air).toFixed(2) : '0.00';
                    document.getElementById('rep-max-turb').textContent = 
                        s.max_tahan ? Math.floor(s.max_tahan) + ' NTU' : '0 NTU';
                    document.getElementById('rep-avg-battery').textContent = 
                        s.avg_daya_listrik ? Math.floor(s.avg_daya_listrik) + '%' : '0%';
                    document.getElementById('rep-total-logs').textContent = s.total_logs || '0';

                    // Table
                    const tbody = document.getElementById('report-table-body');
                    const history = result.history || [];

                    if (history.length === 0) {
                        tbody.innerHTML = `<tr><td colspan="4" class="px-6 py-10 text-center text-xs text-zinc-400">Tidak ada data</td></tr>`;
                    } else {
                        tbody.innerHTML = history.map(row => `
                            <tr class="hover:bg-zinc-800/30">
                                <td class="px-6 py-4 text-xs font-mono text-zinc-400">${row.timestamp || '-'}</td>
                                <td class="px-6 py-4 text-xs font-bold text-cyan-400">${parseFloat(row.kualitas_air).toFixed(1)}</td>
                                <td class="px-6 py-4 text-xs font-bold text-green-400">${Math.floor(row.tahan)} NTU</td>
                                <td class="px-6 py-4 text-xs font-bold text-purple-400">${Math.floor(row.daya_listrik)}%</td>
                            </tr>
                        `).join('');
                    }
                }
            } catch (error) {
                console.error('Error fetching reports:', error);
            }
        }

        // Refresh
        async function refreshSystem() {
            const btn = document.getElementById('refreshBtn');
            const icon = document.getElementById('refreshIcon');
            
            btn.disabled = true;
            icon.setAttribute('data-lucide', 'loader-2');
            icon.classList.add('animate-spin');
            lucide.createIcons();

            await fetchData();
            await fetchReports(document.querySelector('select')?.value || 'daily');

            btn.disabled = false;
            icon.setAttribute('data-lucide', 'refresh-cw');
            icon.classList.remove('animate-spin');
            lucide.createIcons();
        }

        // PDF Export
        function exportToPDF() {
            const btn = document.getElementById('pdfBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';

            html2pdf().from(document.getElementById('section-reports')).save().then(() => {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-download"></i> Export Report (PDF)';
            });
        }

        // Initialize
        initChart();
        fetchData();
        fetchReports();
        setInterval(fetchData, 3000);
        setInterval(() => fetchReports(document.querySelector('select')?.value || 'daily'), 30000);
    </script>
</body>

</html>